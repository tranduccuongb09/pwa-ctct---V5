<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>T√†i li·ªáu h·ªçc t·∫≠p ‚Äì PTKV3</title>

<!-- Font d√πng chung l·∫•y t·ª´ style.css (ƒë·ª´ng override font ·ªü trang n√†y) -->
<link rel="stylesheet" href="style.css">
<!-- N·∫øu anh c√≥ nav.css d√πng chung th√¨ ƒë·ªÉ th√™m d√≤ng n√†y -->
<!-- <link rel="stylesheet" href="nav.css"> -->

<style>
  :root{
    --brand:#A41919; --brand-600:#8B1616;
    --bg:#f6f7fb; --card:#fff; --text:#111827; --muted:#6b7280; --border:#e5e7eb;
    --pill:#f1f5f9;
  }
  *{box-sizing:border-box}
  html,body{
    margin:0; background:var(--bg); color:var(--text);
    /* KH√îNG set font-family ·ªü ƒë√¢y ƒë·ªÉ k·∫ø th·ª´a t·ª´ style.css (Be Vietnam Pro) */
  }
  a{text-decoration:none;color:inherit}

  /* NAV (gi·∫£n l∆∞·ª£c ‚Äì n·∫øu ƒë√£ c√≥ nav.css th√¨ c√≥ th·ªÉ b·ªè kh·ªëi n√†y) */
  .nav{position:sticky;top:0;z-index:10;background:linear-gradient(90deg,#8f1717,#a41919);color:#fff}
  .nav__in{max-width:1120px;margin:auto;padding:12px 14px;display:flex;align-items:center;gap:18px}
  .brand{font-weight:800;white-space:nowrap}
  .nav__links{display:flex;gap:20px;flex:1}
  .nav__links a{color:#fff;opacity:.92}
  .nav__links a.active{color:#ffd966;position:relative}
  .nav__links a.active:after{content:"";position:absolute;left:0;right:0;bottom:-8px;height:3px;background:#ffd966;border-radius:999px}
  .btn-auth{border:1px solid rgba(255,255,255,.7);background:transparent;color:#fff;padding:8px 14px;border-radius:999px;font-weight:700;cursor:pointer}
  .btn-auth:hover{background:#ffd966;color:#111;border-color:#ffd966}

  .container{max-width:1120px;margin:16px auto;padding:0 12px}

  /* ===== NEWS ===== */
  .news{background:#fff;border:1px solid var(--border);border-radius:14px;box-shadow:0 2px 8px rgba(0,0,0,.05);padding:12px}
  .news__hd{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
  .news__title{display:flex;align-items:center;gap:8px;font-weight:900}
  .news__badge{background:#eef2ff;border:1px solid #e5e7eb;border-radius:999px;padding:3px 8px;font-size:12px;color:#1f2937}
  .news__src{color:var(--muted);font-size:12px;opacity:.9}

  /* ===== H√†ng chip ngay d∆∞·ªõi ti√™u ƒë·ªÅ ===== */
  .news__toolbar{display:flex;gap:12px;align-items:center;margin:8px 0 12px}

  /* Chip ng√†y */
  .chip-date{
    display:inline-flex; align-items:center; gap:12px;
    height:44px; padding:6px 12px;
    background:#f3f4f6; color:#111827;
    border:1px solid var(--border); border-radius:4px;
    font-size:13px; line-height:1;
  }
  .cal-ico{display:inline-block; width:16px; height:16px}
  .cal-ico svg{width:16px;height:16px;display:block}

  /* Ticker inline */
  .inline-ticker{
    position:relative; height:44px; flex:1; min-width:260px;
    border:1px solid var(--border); border-radius:4px;
    background:#fff; overflow:hidden;
  }
  .inline-track{
    position:absolute; inset:0 auto 0 0;
    display:flex; align-items:center; gap:30px; white-space:nowrap;
    padding:0 12px; height:44px;
    animation:tickerMove 40s linear infinite; /* t·ªëc ƒë·ªô ch·∫°y */
  }
  @keyframes tickerMove{ from{transform:translateX(0)} to{transform:translateX(-50%)} }
  .inline-ticker:hover .inline-track,
  .inline-ticker:focus-within .inline-track{ animation-play-state:paused }
  @media (prefers-reduced-motion:reduce){ .inline-track{ animation:none; position:static; overflow:auto } }

  .titem{display:inline-flex;align-items:center;gap:10px}
  .t-dot{width:6px;height:6px;border-radius:50%;background:#ef4444;display:inline-block}
  .t-link{font-weight:700;font-size:15px;line-height:1.1} /* c·ª° ch·ªØ ticker */

  /* Huy hi·ªáu NEW (sao ƒë·ªè, ch·ªØ v√†ng) */
  .t-burst{display:inline-block;width:18px;height:18px;vertical-align:middle}
  .t-burst svg{display:block;width:18px;height:18px}
  .t-burst text{font-size:8px;font-weight:900;fill:#ffd966}

  .news__grid{display:grid;gap:12px;grid-template-columns:repeat(3,1fr)}
  @media (max-width:980px){.news__grid{grid-template-columns:repeat(2,1fr)}}
  @media (max-width:640px){.news__grid{grid-template-columns:1fr}}

  .news__card{display:grid;grid-template-columns:112px 1fr;gap:10px;border:1px solid var(--border);border-radius:12px;overflow:hidden;background:#fff}
  .news__thumb{width:112px;height:86px;object-fit:cover;background:#f3f4f6;display:block}
  .news__info{padding:10px 10px 10px 0;display:flex;flex-direction:column}
  .news__titlelink{font-weight:800;line-height:1.28;margin:0 0 6px}
  .news__meta{margin-top:auto;font-size:12px;color:#64748b;display:flex;gap:12px;align-items:center}
  .news__skeleton{height:86px;border:1px dashed var(--border);border-radius:12px;background:#fafafa}

  /* ===== Toolbar & cards ===== */
  .tools{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:12px 0}
  .input,.select{padding:12px 14px;border:1px solid var(--border);border-radius:12px;background:#fff;font-size:16px}
  .input{flex:1;min-width:240px}
  .btn{padding:12px 18px;border-radius:12px;border:none;font-weight:800;font-size:16px;background:var(--brand);color:#fff;cursor:pointer}
  .btn:hover{background:var(--brand-600)}
  .pill{display:inline-flex;align-items:center;gap:8px;background:var(--pill);color:#0f172a;border:1px solid #e2e8f0;border-radius:999px;padding:6px 10px;font-size:13px}

  .topic{margin:18px 0}
  .topic__head{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;background:#fff;border:1px solid var(--border);border-radius:12px}
  .topic__title{margin:0;font-size:18px;font-weight:900}
  .grid{display:grid;gap:14px;grid-template-columns:repeat(2,1fr)}
  @media (max-width:980px){.grid{grid-template-columns:1fr}}

  .card{background:#fff;border:1px solid var(--border);border-radius:16px;box-shadow:0 2px 10px rgba(0,0,0,.05);padding:14px;display:flex;gap:12px}
  .ico{width:56px;height:56px;border-radius:12px;border:1px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:24px}
  .info{flex:1;min-width:0}
  .title{margin:0 0 4px;font-weight:800;line-height:1.35}
  .meta{margin:0 0 8px;color:var(--muted);font-size:13px}
  .actions{display:flex;gap:8px;flex-wrap:wrap}
  .btn-ghost{padding:9px 12px;border-radius:10px;border:1px solid var(--border);background:#fff;font-weight:700;cursor:pointer}
  .btn-ghost:hover{box-shadow:0 2px 6px rgba(0,0,0,.08)}
  .empty{background:#fff;border:1px dashed var(--border);border-radius:14px;padding:24px;text-align:center;color:#64748b}

  /* MODAL */
  .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:50}
  .modal__in{background:#fff;max-width:980px;margin:36px auto;padding:14px;border-radius:14px;max-height:90vh;overflow:auto}
  .modal__hd{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
  .x{border:none;background:#ef4444;color:#fff;border-radius:8px;padding:6px 10px;font-weight:800;cursor:pointer}
  .frame{position:relative;padding-top:56.25%;border-radius:12px;overflow:hidden;background:#000}
  .frame iframe{position:absolute;inset:0;width:100%;height:100%;border:0}

  /* ·∫®n badge ƒë·∫øm b√†i n·∫øu anh kh√¥ng mu·ªën hi·ªán */
  #newsCount { display:none !important; }

   #newsGrid .news__titlelink {
    font-size: 15px;
    line-height: 1.4;
  }
</style>
</head>
<body>

<header class="nav">
  <div class="nav__in">
    <a class="brand" href="index.html">BAN CH·ªà HUY PTKV3</a>
    <nav class="nav__links">
      <a href="index.html">Trang ch·ªß</a>
      <a href="materials.html" class="active">T√†i li·ªáu h·ªçc t·∫≠p</a>
      <a href="quiz.html">L√†m b√†i ki·ªÉm tra</a>
      <a href="leaderboard.html">B·∫£ng x·∫øp h·∫°ng</a>
    </nav>
    <button class="btn-auth">ƒêƒÉng nh·∫≠p/ƒêƒÉng k√Ω</button>
  </div>
</header>

<main class="container">

  <!-- ===== Tin t·ª©c ===== -->
  <section class="news" id="newsBlock">
    <div class="news__hd">
      <div class="news__title">
        <span style="font-size:20px">üì∞</span>
        <span>TIN N·ªîI B·∫¨T</span>
        <span class="news__badge" id="newsCount">‚Ä¶</span>
      </div>
    </div>

    <!-- H√†ng chip theo m·∫´u -->
    <div class="news__toolbar">
      <span class="chip-date">
        <span class="cal-ico" aria-hidden="true">
          <!-- SVG l·ªãch -->
          <svg viewBox="0 0 24 24" fill="none" stroke="#374151" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <rect x="3" y="4" width="18" height="18" rx="3"></rect>
            <line x1="16" y1="2" x2="16" y2="6"></line>
            <line x1="8" y1="2" x2="8" y2="6"></line>
            <line x1="3" y1="10" x2="21" y2="10"></line>
          </svg>
        </span>
        <time id="todayText">‚Äî</time>
      </span>

      <div class="inline-ticker" aria-label="Tin m·ªõi" role="region">
        <div class="inline-track" id="inlineTrack"></div>
      </div>
    </div>

    <div class="news__grid" id="newsGrid">
      <div class="news__skeleton"></div>
      <div class="news__skeleton"></div>
      <div class="news__skeleton"></div>
    </div>
  </section>

  <!-- ===== Toolbar ===== -->
  <div class="tools">
    <input id="q" class="input" placeholder="T√¨m theo ti√™u ƒë·ªÅ/t·ª´ kh√≥a‚Ä¶">
    <select id="topic" class="select" title="Chuy√™n ƒë·ªÅ"></select>
    <select id="year" class="select" title="NƒÉm"></select>
    <button id="clear" class="btn" type="button">Xo√° l·ªçc</button>
    <span class="pill" id="count">0 t√†i li·ªáu</span>
  </div>

  <!-- ===== Materials ===== -->
  <div id="root"></div>
</main>

<!-- Modal -->
<div id="viewer" class="modal" role="dialog" aria-modal="true" aria-labelledby="viewerTitle" tabindex="-1">
  <div class="modal__in">
    <div class="modal__hd">
      <h3 id="viewerTitle" style="margin:0"></h3>
      <button class="x" id="closeViewer" type="button" aria-label="ƒê√≥ng">ƒê√≥ng</button>
    </div>
    <div id="viewerBody"></div>
  </div>
</div>

<!-- C·∫•u h√¨nh d√πng chung -->
<script src="config.js"></script>

<script>
/* ================== L·∫§Y C·∫§U H√åNH T·ª™ config.js ================== */
const { SHEET_API, MATERIALS_FOLDER_ID } = window.CTCT_CONFIG || {};
const API_BASE = SHEET_API || ""; // n·∫øu r·ªóng s·∫Ω hi·ªán n√∫t "Th·ª≠ l·∫°i"

/* Helpers */
const $ = (sel, ctx=document)=>ctx.querySelector(sel);
const fmtTime = s => new Date(s).toLocaleString('vi-VN');
function escapeHtml(s){return String(s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));}
function isSafeHttpUrl(u){ try { const x=new URL(u); return x.protocol==='http:'||x.protocol==='https:'; } catch { return false; } }
function debounce(fn, ms=220){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }

/* H√¥m nay */
function renderToday(){
  const el = $('#todayText'); if(!el) return;
  const d = new Date();
  const wd = d.toLocaleDateString('vi-VN', { weekday:'long' });
  const dd = String(d.getDate()).padStart(2,'0');
  const mm = String(d.getMonth()+1).padStart(2,'0');
  const yyyy = d.getFullYear();
  el.textContent = `${wd.charAt(0).toUpperCase()+wd.slice(1)}, ${dd}/${mm}/${yyyy}`;
}
renderToday();

/* Fetch+retry+cache cho News */
function fetchWithTimeout(url, opts={}, ms=8000){
  const ctrl = new AbortController(); const id = setTimeout(()=>ctrl.abort(), ms);
  return fetch(url, { ...opts, signal: ctrl.signal }).finally(()=>clearTimeout(id));
}
async function tryFetchJSON(url, {tries=3, timeout=8000}={}){
  let lastErr;
  for(let i=0;i<tries;i++){
    try{
      const res = await fetchWithTimeout(url, { cache:'no-store' }, timeout);
      const txt = await res.text();
      if (!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}: ${txt.slice(0,200)}`);
      // b·∫Øt l·ªói khi server tr·∫£ HTML
      if (!/^ *\{|\[/.test(txt)) throw new Error('Not JSON: ' + txt.slice(0,200));
      return JSON.parse(txt);
    }catch(err){
      lastErr = err;
      console.warn('[news] attempt', i+1, err);
      if(i < tries-1) await new Promise(r=>setTimeout(r, (i+1)*1200));
    }
  }
  throw lastErr;
}

const NewsCache = {
  KEY:'ctct_news_cache_v1', TTL: 15*60*1000,
  read(){ try{ const raw=localStorage.getItem(this.KEY); if(!raw) return null;
    const {ts,items}=JSON.parse(raw); if(!Array.isArray(items)) return null;
    if(Date.now()-ts>this.TTL) return null; return items; }catch{ return null; } },
  write(items){ try{ localStorage.setItem(this.KEY, JSON.stringify({ts:Date.now(),items})); }catch{} }
};

/* NEW burst icon */
function newBurstSVG(){
  return `
    <span class="t-burst" aria-label="Tin m·ªõi">
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <polygon fill="#e11d48"
          points="12,1 14.8,5.2 20,4 17.8,8.8 22.5,12 17.8,15.2 20,20 14.8,18.8 12,23 9.2,18.8 4,20 6.2,15.2 1.5,12 6.2,8.8 4,4 9.2,5.2" />
        <text x="12" y="13.5" text-anchor="middle" style="font-size:8px;font-weight:900;fill:#ffd966">NEW</text>
      </svg>
    </span>`;
}

/* Ticker inline */
function renderInlineTicker(items){
  const track = $('#inlineTrack'); if(!track) return;
  const list = (items||[]).slice(0, 30);
  if(!list.length){
    track.innerHTML = `<span class="titem" style="padding:0 12px;color:#64748b">ƒêang c·∫≠p nh·∫≠t‚Ä¶</span>`;
    return;
  }
  const tpl = it => {
    const url = isSafeHttpUrl(it.url) ? it.url : '#';
    return `
      <span class="titem">
        <span class="t-dot"></span>
        <a class="t-link" href="${url}" target="_blank" rel="noopener">${escapeHtml(it.title||'Tin m·ªõi')}</a>
        ${newBurstSVG()}
      </span>`;
  };
  const stripe = list.map(tpl).join('');
  track.innerHTML = stripe + stripe; // l·∫∑p ƒë·ªÉ ch·∫°y li√™n t·ª•c
}

/* NEWS */
document.addEventListener('DOMContentLoaded', loadNewsToGrid);

async function loadNewsToGrid(){
  const grid = $('#newsGrid');
  const counter = $('#newsCount');

  const showSkeleton = () => {
    if(counter) counter.textContent = '‚Ä¶';
    grid.innerHTML = `<div class="news__skeleton"></div><div class="news__skeleton"></div><div class="news__skeleton"></div>`;
  };
  function bindOpenNews(container){
    container.querySelectorAll('.news__card').forEach(card=>{
      const open = ()=>{ const href = card.getAttribute('data-href'); if (isSafeHttpUrl(href)) window.open(href, '_blank', 'noopener,noreferrer'); };
      card.addEventListener('click', open);
      card.addEventListener('keydown', e=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); open(); }});
    });
  }
  function renderRetry(msg){
    if(counter) counter.textContent = '0 b√†i';
    grid.innerHTML = `
      <div class="news__card" style="grid-column:1/-1; display:flex; align-items:center; justify-content:center; padding:12px">
        <div style="text-align:center">
          <div style="margin-bottom:8px">${msg}</div>
          <button id="newsRetry" class="btn-ghost" type="button">Th·ª≠ l·∫°i</button>
          <div style="margin-top:8px; font-size:12px; color:#64748b">
            ${navigator.onLine ? 'M√°y ch·ªß ch·∫≠m ho·∫∑c ph·∫£n h·ªìi kh√¥ng h·ª£p l·ªá.' : 'B·∫°n ƒëang ngo·∫°i tuy·∫øn.'}
          </div>
        </div>
      </div>`;
    document.getElementById('newsRetry')?.addEventListener('click', ()=>{ showSkeleton(); loadNewsToGrid(); });
  }

  if(!API_BASE){ renderRetry('Ch∆∞a c·∫•u h√¨nh API tin t·ª©c (SHEET_API).'); return; }

  const cached = NewsCache.read();
  if(cached && cached.length){
    if(counter) counter.textContent = `${cached.length} b√†i`;
    grid.innerHTML = cached.slice(0,9).map(renderNewsCard).join('');
    bindOpenNews(grid);
    renderInlineTicker(cached);
  } else {
    showSkeleton();
  }

  try{
    const url = `${API_BASE}?action=news&limitPer=5&total=18`;
    const data = await tryFetchJSON(url, {tries:3, timeout:8000});
    const items = Array.isArray(data.items) ? data.items : [];
    if(items.length){
      if(counter) counter.textContent = `${items.length} b√†i`;
      grid.innerHTML = items.slice(0,9).map(renderNewsCard).join('');
      bindOpenNews(grid);
      NewsCache.write(items);
      renderInlineTicker(items);
    }else if(!cached){
      renderRetry('Ch∆∞a c√≥ b√†i ph√π h·ª£p t·ª´ ngu·ªìn.');
    }
  }catch(err){
    if(!cached){ renderRetry('L·ªói m·∫°ng ho·∫∑c m√°y ch·ªß ch·∫≠m.'); }
    console.warn('[news] error', err);
  }
}

function renderNewsCard(n){
  const url = isSafeHttpUrl(n.url) ? n.url : '#';
  const thumb = n.thumb && isSafeHttpUrl(n.thumb) ? n.thumb : '';
  const time = n.date ? fmtTime(n.date) : '';
  return `
    <article class="news__card" data-href="${url}" tabindex="0" role="link">
      <a href="${url}" target="_blank" rel="noopener">
        <img class="news__thumb" src="${thumb}" alt=""
             onerror="this.src='data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22112%22 height=%2286%22><rect width=%22100%25%22 height=%22100%25%22 fill=%22%23f3f4f6%22/><text x=%2250%25%22 y=%2255%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 fill=%22%239ca3af%22 font-family=%22system-ui%22 font-size=%2212%22>no image</text></svg>'"/>
      </a>
      <div class="news__info">
        <a class="news__titlelink" href="${url}" target="_blank" rel="noopener">${escapeHtml(n.title||'')}</a>
        <div class="news__meta">
          <span>${time}</span>
        </div>
      </div>
    </article>`;
}


/* ===== Materials (API ho·∫∑c MOCK) ===== */
const ICON = { pdf:'üìÑ', video:'üì∫', audio:'üéß', slide:'üñº', news:'üì∞' };
async function fetchMaterialsFromApi(){
  if (!MATERIALS_FOLDER_ID) return null;
  try{
    const url = `${API_BASE}?action=materials&folderId=${encodeURIComponent(MATERIALS_FOLDER_ID)}`;
    const res = await fetch(url, {cache:'no-store'});
    if (!res.ok) throw 0;
    const data = await res.json();
    return (data.files||[]).map(f=>({
      id:f.id, type:'pdf', title:f.title, topic:'Ch∆∞a ph√¢n lo·∫°i',
      updated:f.updated, source:'Drive', url:f.url
    }));
  }catch{ return null; }
}
const MOCK = [
  {id:'p1', type:'pdf',  title:'TPB Tu·∫ßn CN.pdf', topic:'ƒêi·ªÅu l·ªánh ‚Äì K·ª∑ lu·∫≠t', updated:'2025-09-13T23:41:30', source:'N·ªôi b·ªô', url:'https://drive.google.com/file/d/xxx/preview'},
  {id:'v1', type:'video',title:'Video: Gi·ªõi thi·ªáu Lu·∫≠t NVQS s·ª≠a ƒë·ªïi', topic:'Ph√°p lu·∫≠t Nh√† n∆∞·ªõc', updated:'2025-09-12T10:00:00', source:'QPVN', url:'https://www.youtube.com/embed/dQw4w9WgXcQ'},
  {id:'a1', type:'audio',title:'Audio: X√¢y d·ª±ng khu v·ª±c ph√≤ng th·ªß', topic:'Ph√°p lu·∫≠t Nh√† n∆∞·ªõc', updated:'2025-09-10T09:00:00', source:'CTƒê, CTCT', url:'https://cdn.pixabay.com/audio/2021/11/02/audio_8b8d3.mp3'}
];

const root = $('#root'), qEl=$('#q'), topicSel=$('#topic'), yearSel=$('#year'), countEl=$('#count');
let MATERIALS = [];

(async function init(){
  try{ MATERIALS = await fetchMaterialsFromApi() || MOCK; }catch{ MATERIALS = MOCK; }

  const TOPICS = [...new Set(MATERIALS.map(x=>x.topic))].sort((a,b)=>a.localeCompare(b,'vi'));
  const YEARS  = [...new Set(MATERIALS.map(x=>new Date(x.updated).getFullYear()))].sort((a,b)=>b-a);
  topicSel.innerHTML = '<option value="">T·∫•t c·∫£ chuy√™n ƒë·ªÅ</option>' + TOPICS.map(t=>`<option>${escapeHtml(t)}</option>`).join('');
  yearSel.innerHTML  = '<option value="">T·∫•t c·∫£ nƒÉm</option>'      + YEARS.map(y=>`<option>${y}</option>`).join('');

  qEl.addEventListener('input', debounce(applyFilter, 220));
  topicSel.addEventListener('change', applyFilter);
  yearSel.addEventListener('change', applyFilter);
  $('#clear').addEventListener('click', ()=>{ qEl.value=''; topicSel.value=''; yearSel.value=''; applyFilter(); });

  applyFilter();
})();

function applyFilter(){
  const kw=(qEl.value||'').trim().toLowerCase();
  const t = topicSel.value, y = yearSel.value;
  const list = MATERIALS.filter(x=>{
    const okKW = !kw || x.title.toLowerCase().includes(kw);
    const okT  = !t || x.topic===t;
    const okY  = !y || String(new Date(x.updated).getFullYear())===y;
    return okKW && okT && okY;
  });
  countEl.textContent = `${list.length} t√†i li·ªáu`;
  if (!list.length){ root.innerHTML = '<div class="empty">Kh√¥ng c√≥ t√†i li·ªáu ph√π h·ª£p.</div>'; return; }

  const map = new Map();
  for(const it of list){ if(!map.has(it.topic)) map.set(it.topic, []); map.get(it.topic).push(it); }
  root.innerHTML = Array.from(map.entries()).map(([topic, arr])=>`
    <section class="topic">
      <div class="topic__head">
        <h3 class="topic__title">üìÇ ${escapeHtml(topic)}</h3>
        <span class="pill">${arr.length} m·ª•c</span>
      </div>
      <div class="grid">
        ${arr.map(renderCard).join('')}
      </div>
    </section>
  `).join('');
}

function renderCard(it){
  const ico = ICON[it.type]||'üìÑ';
  const openBtn = {
    pdf:   `<button class="btn" data-open="${it.id}" type="button">M·ªü</button>`,
    video: `<button class="btn" data-open="${it.id}" type="button">Xem video</button>`,
    audio: `<button class="btn" data-open="${it.id}" type="button">Nghe</button>`,
    slide: `<button class="btn-ghost" type="button" onclick="alert('M·ªü slide demo');">M·ªü slide</button>`,
    news:  `<a class="btn" target="_blank" rel="noopener" href="${it.url}">ƒê·ªçc</a>`
  }[it.type] || `<button class="btn" data-open="${it.id}" type="button">M·ªü</button>`;

  const dl = (it.url && it.type==='pdf' && isSafeHttpUrl(it.url))
              ? it.url.replace('/preview','/view?usp=drivesdk')
              : '#';

  return `
  <article class="card">
    <div class="ico" aria-hidden="true">${ico}</div>
    <div class="info">
      <h4 class="title">${escapeHtml(it.title)}</h4>
      <p class="meta">C·∫≠p nh·∫≠t: ${fmtTime(it.updated)} ¬∑ Ngu·ªìn: ${escapeHtml(it.source||'‚Äî')}</p>
      <div class="actions">
        ${openBtn}
        <a class="btn-ghost" href="${dl}" target="_blank" rel="noopener">T·∫£i xu·ªëng</a>
        ${it.type!=='news' ? `<button class="btn-ghost" type="button" onclick="alert('Mini-quiz demo!')">Mini-Quiz</button>` : ''}
        ${it.type!=='news' ? `<button class="btn-ghost" type="button" onclick="alert('H·ªèi AI v·ªÅ: ${escapeHtml(it.title)}')">H·ªèi AI</button>` : ''}
      </div>
    </div>
  </article>`;
}

/* Modal viewer */
const viewer = $('#viewer'), viewerTitle = $('#viewerTitle'), viewerBody = $('#viewerBody');
$('#closeViewer').onclick = ()=> viewer.style.display='none';
window.addEventListener('click', e => { if(e.target===viewer) viewer.style.display='none'; });

document.addEventListener('click', e=>{
  const btn = e.target.closest('[data-open]'); if(!btn) return;
  const it = MATERIALS.find(x=>x.id===btn.dataset.open); if(!it) return;
  viewerTitle.textContent = it.title;
  viewerBody.innerHTML = renderViewer(it);
  viewer.style.display='block';
  viewer.focus();
  const onEsc = (ev)=>{ if(ev.key==='Escape'){ viewer.style.display='none'; document.removeEventListener('keydown', onEsc); } };
  document.addEventListener('keydown', onEsc);
});

function renderViewer(it){
  if (it.type==='video'){
    const src = isSafeHttpUrl(it.url) ? it.url : '';
    return src ? `<div class="frame"><iframe src="${src}" allow="accelerometer; autoplay; encrypted-media" allowfullscreen referrerpolicy="no-referrer"></iframe></div>`
               : `<div class="empty">Video kh√¥ng kh·∫£ d·ª•ng.</div>`;
  }
  if (it.type==='audio'){
    const src = isSafeHttpUrl(it.url) ? it.url : '';
    return src ? `<audio controls style="width:100%"><source src="${src}">Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ audio.</audio>`
               : `<div class="empty">Audio kh√¥ng kh·∫£ d·ª•ng.</div>`;
  }
  const src = it.url && it.url.includes('/preview') && isSafeHttpUrl(it.url) ? it.url : '';
  return src ? `<div class="frame"><iframe src="${src}" referrerpolicy="no-referrer"></iframe></div>`
             : `<div class="empty">T√†i li·ªáu kh√¥ng kh·∫£ d·ª•ng.</div>`;
}
</script>
</body>
</html>
