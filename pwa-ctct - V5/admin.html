<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Quản trị – CTĐ, CTCT</title>
<link rel="manifest" href="manifest.webmanifest">
<link rel="stylesheet" href="nav.css">
<style>
  :root{ --brand:#A41919; --border:#e5e7eb; --muted:#6b7280; --bg:#f5f6f8 }
  body{margin:0;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  .container{max-width:1200px;margin:16px auto;padding:0 12px}
  .grid{display:grid;gap:12px;grid-template-columns:repeat(3,minmax(0,1fr))}
  @media (max-width:1024px){.grid{grid-template-columns:1fr}}
  .card{background:#fff;border:1px solid var(--border);border-radius:14px;box-shadow:0 2px 10px rgba(0,0,0,.06);padding:16px}
  h2{margin:0 0 10px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left}
  .muted{color:var(--muted)}
  .btn{padding:10px 14px;border-radius:10px;border:1px solid var(--border);background:#fff;cursor:pointer}
  .btn.primary{background:var(--brand);color:#fff;border:none}
  input.input{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px}
</style>
<script>
if ('serviceWorker' in navigator) addEventListener('load',()=>navigator.serviceWorker.register('./sw.js'));
</script>
</head>
<body>
<header class="nav"><div class="nav__inner">
  <a class="brand" href="index.html">BAN CHỈ HUY PTKV3</a>
  <nav class="nav__links">
    <a href="index.html">Trang chủ</a>
    <a href="materials.html">Tài liệu học tập</a>
    <a href="quiz.html">Làm bài kiểm tra</a>
    <a href="leaderboard.html">Bảng xếp hạng</a>
    <a href="admin.html" class="is-active">Quản trị</a>
  </nav>
</div></header>

<main class="container">
  <div class="grid">
    <section class="card">
      <h2>Tổng quan tham gia</h2>
      <div id="summary" class="muted">Đang tải…</div>
      <div style="margin-top:10px">
        <button id="exportExcel" class="btn">Xuất Excel (đợt hiện tại)</button>
      </div>
    </section>

    <section class="card">
      <h2>Chuyên đề cần bồi dưỡng</h2>
      <table id="weak">
        <thead><tr><th>Chuyên đề</th><th>% đúng</th></tr></thead>
        <tbody><tr><td colspan="2" class="muted">Đang tải…</td></tr></tbody>
      </table>
    </section>

    <section class="card">
      <h2>Quản lý đợt thi</h2>
      <label>Tên đợt <input id="batchName" class="input" placeholder="VD: Đợt 9/2025"></label><br>
      <label>Chuyên đề <input id="batchTopic" class="input" placeholder="VD: Điều lệnh"></label><br>
      <button id="createBatch" class="btn primary">Tạo đợt</button>
      <div id="batchMsg" class="muted" style="margin-top:8px"></div>
    </section>
  </div>
</main>

<script src="config.js" defer></script>
<script src="net.js" defer></script>
<script src="analytics.js" defer></script>
<script>
(async function loadDashboard(){
  const { SHEET_API } = window.CTCT_CONFIG;
  try{
    const data = await fetchJSON(SHEET_API+'?action=dashboard', {}, 10000, 1);
    const d = typeof data === 'string' ? JSON.parse(data) : data || {};
    const s = document.getElementById('summary');
    s.innerHTML = `
      Tổng lượt làm: <b>${d.totalSubmits||0}</b><br>
      Người tham gia: <b>${d.totalUsers||0}</b><br>
      Điểm trung bình: <b>${Number(d.avgScore||0).toFixed(2)}</b>
    `;
    const tb = document.querySelector('#weak tbody');
    const rows = (d.weakTopics||[]);
    tb.innerHTML = rows.length
      ? rows.map(r=>`<tr><td>${r.topic}</td><td>${Number(r.pct||0).toFixed(1)}%</td></tr>`).join('')
      : '<tr><td colspan="2" class="muted">Chưa có dữ liệu</td></tr>';
  }catch(e){
    console.error('[admin] dashboard', e);
    toast('Không tải được thống kê.');
  }
})();

document.getElementById('exportExcel').addEventListener('click', async ()=>{
  const { SHEET_API } = window.CTCT_CONFIG;
  try{
    const res = await fetchJSON(SHEET_API+'?action=exportExcel', {}, 15000, 0);
    const d = typeof res === 'string' ? JSON.parse(res) : res;
    if (d && d.url) location.href = d.url; else toast('Không xuất được file.');
  }catch(e){ toast('Lỗi xuất Excel'); }
});

document.getElementById('createBatch').addEventListener('click', async ()=>{
  const name = document.getElementById('batchName').value.trim();
  const topic= document.getElementById('batchTopic').value.trim();
  if(!name || !topic) return toast('Nhập tên đợt và chuyên đề.');
  const { SHEET_API } = window.CTCT_CONFIG;
  try{
    const d = await fetchJSON(SHEET_API+'?action=createBatch', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ name, topic })
    }, 12000, 0);
    const ok = (typeof d==='string'?JSON.parse(d):d)?.ok;
    document.getElementById('batchMsg').textContent = ok ? 'Tạo đợt thành công.' : 'Không tạo được đợt.';
    window.ctctLog && window.ctctLog('admin_create_batch', { name, topic, ok: !!ok });
  }catch(e){ toast('Lỗi kết nối khi tạo đợt.'); }
});
</script>
</body>
</html>
