<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ÄÄƒng nháº­p / ÄÄƒng kÃ½ â€“ CTÄ, CTCT</title>

  <!-- PWA -->
  <link rel="manifest" href="../../public/manifest.webmanifest">
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => { try { navigator.serviceWorker.register('../../public/sw.js'); } catch(_){} });
    }
  </script>

  <!-- Style chung + nav -->
  <link rel="stylesheet" href="../css/style.css">
  <link rel="stylesheet" href="../css/nav.css">
  <style>
    :root{ --brand:#A41919; --brand-600:#8B1616; --ring:#e5e7eb; --bg:#f6f7fb; --muted:#6b7280 }
    body{ background:#fff; color:#111827 }
    .wrap{ max-width:980px; margin:24px auto; padding:0 16px }
    .auth-card{
      background:#fff; border:1px solid var(--ring); border-radius:16px;
      box-shadow:0 8px 28px rgba(0,0,0,.08); overflow:hidden;
    }
    .auth-head{
      background:linear-gradient(135deg,var(--brand),var(--brand-600));
      color:#fff; padding:18px; display:flex; align-items:center; justify-content:space-between;
    }
    .auth-head h1{ margin:0; font-size:20px; letter-spacing:.3px }
    .tabs{ display:flex; gap:6px; background:#fafafa; border-bottom:1px solid var(--ring) }
    .tab{
      flex:1; text-align:center; padding:12px; font-weight:800; cursor:pointer; user-select:none;
      border-right:1px solid var(--ring);
    }
    .tab:last-child{ border-right:0 }
    .tab.active{ background:#fff; color:var(--brand); box-shadow:inset 0 -3px 0 var(--brand) }
    .pane{ padding:18px }
    .grid{ display:grid; grid-template-columns:1fr 1fr; gap:12px }
    @media (max-width:720px){ .grid{ grid-template-columns:1fr } }
    .input{
      width:100%; padding:12px 14px; border:1px solid var(--ring); border-radius:12px; background:#fff; font-size:16px;
    }
    .hint{ color:var(--muted); font-size:13px }
    .actions{ display:flex; gap:10px; justify-content:flex-end; margin-top:10px }
    .btn{ padding:12px 16px; border-radius:12px; border:1px solid var(--ring); background:#fff; font-weight:800; cursor:pointer }
    .btn-primary{ background:var(--brand); border-color:var(--brand); color:#fff }
    .btn-primary:hover{ filter:brightness(.98) }
    .badge{ display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; background:#f3f4f6; font-weight:700 }
    .muted{ color:var(--muted) }
    .foot{ display:flex; justify-content:space-between; padding:14px 18px; border-top:1px solid var(--ring); background:#fafafa }
  </style>
</head>
<body>
  <nav class="topbar" style="background:var(--brand);color:#fff">
    <a href="index.html" class="back" style="color:#fff;text-decoration:none">â† Trang chá»§</a>
    <h2>ÄÄ‚NG NHáº¬P / ÄÄ‚NG KÃ</h2>
  </nav>

  <main class="wrap">
    <section class="auth-card">
      <div class="auth-head">
        <h1>GIÃO Dá»¤C CHÃNH TRá»Š Sá» â€“ PTKV3</h1>
        <span class="badge">ğŸ”’ Báº£o vá»‡ truy cáº­p thi & káº¿t quáº£</span>
      </div>

      <div class="tabs">
        <div id="tabLogin" class="tab active">ÄÄƒng nháº­p</div>
        <div id="tabRegister" class="tab">ÄÄƒng kÃ½</div>
      </div>

      <!-- PANE: LOGIN -->
      <div id="paneLogin" class="pane">
        <div class="grid">
          <label>Há» vÃ  tÃªn
            <input id="l_name" class="input" autocomplete="name" placeholder="VD: Nguyá»…n VÄƒn A">
          </label>
          <label>ÄÆ¡n vá»‹
            <input id="l_unit" class="input" placeholder="VD: Tiá»ƒu Ä‘oÃ nâ€¦">
          </label>
          <label>Chá»©c vá»¥ (tuá»³ chá»n)
            <input id="l_position" class="input" placeholder="VD: Trung Ä‘á»™i trÆ°á»Ÿng">
          </label>
          <label>Vai trÃ² (phÃ¢n quyá»n)
            <select id="l_role" class="input">
              <option value="member">ThÃ nh viÃªn</option>
              <option value="unit_viewer">Xem káº¿t quáº£ Ä‘Æ¡n vá»‹</option>
              <option value="ptkv_viewer">Xem cáº¥p PTKV</option>
              <option value="province_admin">Tá»‰nh (Chá»‰ huy trÆ°á»Ÿng/ChÃ­nh uá»·)</option>
            </select>
          </label>
        </div>
        <p class="hint">ÄÄƒng nháº­p nhanh chá»‰ lÆ°u há»“ sÆ¡ trÃªn thiáº¿t bá»‹ Ä‘á»ƒ má»Ÿ quyá»n truy cáº­p thi & xem káº¿t quáº£ theo vai trÃ² do quáº£n trá»‹ cáº¥p phÃ¡t.</p>
        <div class="actions">
          <a class="btn" href="index.html">Huá»·</a>
          <button id="btnLogin" class="btn btn-primary">ÄÄƒng nháº­p</button>
        </div>
      </div>

      <!-- PANE: REGISTER -->
      <div id="paneRegister" class="pane" hidden>
        <div class="grid">
          <label>Há» vÃ  tÃªn
            <input id="r_name" class="input" autocomplete="name">
          </label>
          <label>ÄÆ¡n vá»‹
            <input id="r_unit" class="input">
          </label>
          <label>Chá»©c vá»¥
            <input id="r_position" class="input">
          </label>
          <label>Email (Ä‘á»ƒ liÃªn há»‡ phÃª duyá»‡t)
            <input id="r_email" class="input" type="email" placeholder="ten@donvi.vn">
          </label>
          <label>MÃ£ Ä‘Æ¡n vá»‹ (náº¿u cÃ³)
            <input id="r_unitCode" class="input" placeholder="VD: PTKV3-TD1">
          </label>
          <label>Vai trÃ² mong muá»‘n
            <select id="r_role" class="input">
              <option value="member">ThÃ nh viÃªn (máº·c Ä‘á»‹nh)</option>
              <option value="unit_viewer">Xem káº¿t quáº£ Ä‘Æ¡n vá»‹</option>
            </select>
          </label>
        </div>
        <p class="hint">YÃªu cáº§u Ä‘Äƒng kÃ½ sáº½ Ä‘Æ°á»£c lÆ°u kÃ¨m há»“ sÆ¡ cá»¥c bá»™. Quáº£n trá»‹ cÃ³ thá»ƒ Ä‘á»‘i chiáº¿u & nÃ¢ng quyá»n sau.</p>
        <div class="actions">
          <a class="btn" href="index.html">Huá»·</a>
          <button id="btnRegister" class="btn btn-primary">ÄÄƒng kÃ½</button>
        </div>
      </div>

      <div class="foot">
        <span class="muted">ThÆ°Æ¡ng hiá»‡u â€¢ mÃ u chá»§ Ä‘áº¡o #A41919 Ä‘á»“ng bá»™ toÃ n site</span>
        <a class="btn" href="materials.html">TÃ i liá»‡u há»c táº­p</a>
      </div>
    </section>
  </main>

  <!-- JS chung -->
  <script src="../js/config.js" defer></script>
  <script src="../js/net.js" defer></script>
  <script src="../js/analytics.js" defer></script>
  <script src="../js/navbar.js" defer></script>

  <!-- Logic auth ná»™i trang -->
  <script>
    const LS_KEY = 'ctct_profile';
    const J = { parse:(s,f=null)=>{try{return JSON.parse(s)}catch{ return f }}, str:o=>JSON.stringify(o||{}) };

    const $ = (id)=>document.getElementById(id);
    const tabLogin = $('tabLogin'), tabRegister = $('tabRegister');
    const paneLogin = $('paneLogin'), paneRegister = $('paneRegister');

    tabLogin.addEventListener('click', ()=>{ tabLogin.classList.add('active'); tabRegister.classList.remove('active'); paneLogin.hidden=false; paneRegister.hidden=true; });
    tabRegister.addEventListener('click', ()=>{ tabRegister.classList.add('active'); tabLogin.classList.remove('active'); paneLogin.hidden=true; paneRegister.hidden=false; });

    function redirectAfter(){
      const next = new URLSearchParams(location.search).get('next');
      location.href = next ? next : 'index.html';
    }

    function saveProfile(p){
      localStorage.setItem(LS_KEY, J.str(p));
      try{ window.dispatchEvent(new StorageEvent('storage',{key:LS_KEY})); }catch(_){}
    }

    // ÄÄƒng nháº­p
    $('btnLogin').addEventListener('click', ()=>{
      const name=($('l_name').value||'').trim();
      const unit=($('l_unit').value||'').trim();
      if(!name || !unit){ alert('Vui lÃ²ng nháº­p Há» tÃªn vÃ  ÄÆ¡n vá»‹.'); return; }
      const position = ($('l_position').value||'').trim();
      const role = ($('l_role').value||'member');
      saveProfile({ name, unit, position, role, unitCode:'', registered:true, ts: Date.now() });
      window.toast && toast('ÄÄƒng nháº­p thÃ nh cÃ´ng!');
      redirectAfter();
    });

    // ÄÄƒng kÃ½
    $('btnRegister').addEventListener('click', ()=>{
      const name=($('r_name').value||'').trim();
      const unit=($('r_unit').value||'').trim();
      if(!name || !unit){ alert('Vui lÃ²ng nháº­p Há» tÃªn vÃ  ÄÆ¡n vá»‹.'); return; }
      const position=($('r_position').value||'').trim();
      const email=($('r_email').value||'').trim();
      const unitCode=($('r_unitCode').value||'').trim();
      const role=($('r_role').value||'member');

      // LÆ°u local + gá»­i log lÃªn Apps Script (náº¿u muá»‘n)
      const profile = { name, unit, position, email, unitCode, role, registered:true, ts: Date.now() };
      saveProfile(profile);

      // ghi log Ä‘Äƒng kÃ½ (tuá»³ chá»n)
      try{
        const { SHEET_API } = window.CTCT_CONFIG || {};
        if (SHEET_API) {
          fetchJSON(SHEET_API+'?action=log', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ action:'log', event:'register', me:profile, ts:new Date().toISOString(), ua:navigator.userAgent })
          });
        }
      }catch(_){}

      window.toast && toast('ÄÄƒng kÃ½ thÃ nh cÃ´ng!');
      redirectAfter();
    });
  </script>
</body>
</html>
