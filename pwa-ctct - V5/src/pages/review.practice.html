<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>XEM L·∫†I & GI·∫¢I TH√çCH ‚Äî √în tr·∫Øc nghi·ªám</title>

  <link rel="manifest" href="manifest.webmanifest">
  <!-- Gi·ªØ file polish c·ªßa anh -->
  <link rel="stylesheet" href="../css/review-polish.css">

  <style>
    /* B·ªï sung r·∫•t nh·ªè cho c·ª•m ch·ªâ s·ªë & footer ‚Äì kh·ªõp ·∫£nh m·∫´u */
    .metrics{display:flex;align-items:center;gap:10px;flex-wrap:wrap;
      background:#fff;border:1px solid var(--border,#e5e7eb);border-radius:12px;padding:10px 12px}
    .chip{display:inline-flex;align-items:center;gap:8px;border-radius:999px;
      padding:6px 10px;font-weight:800;background:#f8fafc;border:1px solid #e5e7eb}
    .chip b{font-weight:900}
    .chip.total{background:#eef2ff}
    .chip.ok{background:#ecfdf5}
    .chip.bad{background:#fef2f2}
    .chip.skip{background:#fff7ed}
    .metrics__right{margin-left:auto;color:#475569}
    .qa-card{background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:14px 16px}
    .qa-card+.qa-card{margin-top:12px}
    .qa-card .exp{margin-top:8px;color:#475569;background:#f8fafc;border:1px dashed #e5e7eb;
      border-radius:10px;padding:10px}
    .qa-card.ok .result{color:#065f46;font-weight:700}
    .qa-card.ng .result{color:#991b1b;font-weight:700}
    .footer-actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:16px}
    .btn{display:inline-flex;align-items:center;gap:8px;height:44px;padding:0 14px;border-radius:12px;
      border:1px solid #e5e7eb;background:#fff;font-weight:800;text-decoration:none;color:#111827}
    .btn.primary{background:#A41919;color:#fff;border-color:#A41919}
    .btn:hover{filter:brightness(.98)}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:10px}
    .field{display:inline-flex;align-items:center;gap:8px;border:1px solid #e5e7eb;border-radius:12px;background:#fff;padding:8px 10px}
    .field input[type="search"]{border:0;outline:0;min-width:260px}
    .btn-print{display:inline-flex;align-items:center;gap:6px;border:1px solid #e5e7eb;border-radius:12px;background:#fff;padding:8px 12px}
  </style>
</head>
<body>
  <!-- Topbar gi·ªØ m√†u th∆∞∆°ng hi·ªáu -->
  <div class="topbar">
    <a href="index.html">‚Üê Trang ch·ªß</a>
    <strong style="margin-left:10px">XEM L·∫†I &amp; GI·∫¢I TH√çCH ‚Äî √îN TR·∫ÆC NGHI·ªÜM</strong>
  </div>

  <main class="wrap">
    <!-- Toolbar: ch·ªâ hi·ªán sai + search + in/pdf -->
    <div class="toolbar sticky">
      <label class="field" style="gap:10px"><input id="onlyWrong" type="checkbox"> <b>Ch·ªâ hi·ªán c√¢u sai</b></label>
      <label class="field" style="flex:1 1 230px">
        üîé <input id="searchBox" type="search" placeholder="Nh·∫≠p t·ª´ kh√≥a‚Ä¶">
      </label>
      <button id="printBtn" class="btn-print">üñ®Ô∏è In/PDF</button>
    </div>

    <!-- C·ª•m ch·ªâ s·ªë ƒë·ªông + ‚ÄúHi·ªÉn th·ªã: n m·ª•c‚Äù -->
    <div class="metrics" id="metricsBar" aria-live="polite">
      <span class="chip total">üìã T·ªïng c√¢u: <b id="statTotal">0</b></span>
      <span class="chip ok">‚úÖ ƒê√∫ng: <b id="statOk">0</b></span>
      <span class="chip bad">‚ùå Sai: <b id="statBad">0</b></span>
      <span class="chip skip">‚è≥ Ch∆∞a TL: <b id="statSkip">0</b></span>
      <span class="metrics__right">Hi·ªÉn th·ªã: <b id="statVisible">0</b> m·ª•c</span>
    </div>

    <!-- Danh s√°ch c√¢u h·ªèi (s·∫Ω ƒë∆∞·ª£c chu·∫©n ho√° + g·∫Øn class b·∫±ng normalize + core) -->
    <section id="reviewList" style="margin-top:12px"></section>

    <section style="margin-top:12px">
      <div class="footer-actions">
        <a class="btn" href="practice.html">‚Üª Quay l·∫°i √în tr·∫Øc nghi·ªám</a>
        <a class="btn" href="leaderboard.html">üìä B·∫£ng x·∫øp h·∫°ng</a>
        <a class="btn primary" href="materials.html">üìö V·ªÅ t√†i li·ªáu h·ªçc t·∫≠p</a>
      </div>
    </section>
  </main>

  <!-- L·∫•y d·ªØ li·ªáu c≈© t·ª´ localStorage, render nh∆∞ b·∫£n anh ƒëang d√πng -->
  <script>
    (function(){
      const LS_KEY='ctct_try_last_result';
      const pack=safeParse(localStorage.getItem(LS_KEY));
      const list=document.getElementById('reviewList');

      if(!pack || !Array.isArray(pack.details)){
        list.innerHTML='<div class="qa-card">Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xem l·∫°i. H√£y ho√†n th√†nh m·ªôt l∆∞·ª£t √¥n tr·∫Øc nghi·ªám.</div>';
        return;
      }

      list.innerHTML=(pack.details||[]).map((d,i)=>{
        const chosen=(d.chosen||'').trim(), correct=(d.correct||'').trim();
        const answered=!!chosen, ok=answered && chosen===correct;
        const status=!answered
          ? `‚Äî <b>Kh√¥ng tr·∫£ l·ªùi</b> ‚Ä¢ ƒê√∫ng: <b>${escapeHtml(correct||'-')}</b>`
          : ok
            ? `‚úî ƒê√∫ng ‚Äî B·∫°n ch·ªçn: <b>${escapeHtml(chosen)}</b> ‚Ä¢ ƒê√∫ng: <b>${escapeHtml(correct)}</b>`
            : `‚úò Sai ‚Äî B·∫°n ch·ªçn: <b>${escapeHtml(chosen||'‚Äî')}</b> ‚Ä¢ ƒê√∫ng: <b>${escapeHtml(correct)}</b>`;
        const exp=(d.explanation||'').trim();
        const idx = Number(d.index || i+1);
        return `
        <article class="qa-card ${ok?'ok':answered?'ng bad':'skip'} qitem" data-qindex="${idx}" data-ok="${ok?'1':'0'}" data-answered="${answered?'1':'0'}">
          <header class="qhead" style="font-weight:800;margin-bottom:6px">C√¢u ${idx}.</header>
          <p class="qtext">${escapeHtml(d.question||'')}</p>
          <p class="result">${status}</p>
          ${exp?`<div class="exp"><b>Gi·∫£i th√≠ch:</b> ${escapeHtml(exp)}</div>`:''}
        </article>`;
      }).join('');

      function safeParse(s){ try{return JSON.parse(s||'null')}catch(_){return null} }
      function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[m])); }
    })();
  </script>

  <!-- Core c·ªßa anh (ƒë√£ ch·∫°y ·ªïn) -->
  <script src="../js/review-normalize.js?v=20251006"></script>
  <script src="../js/review-core.js?v=20251006"></script>

  <!-- K·∫øt n·ªëi control + c·∫≠p nh·∫≠t CH·ªà S·ªê ƒë·ªông -->
  <script>
    (function(){
      const $ = (sel)=>document.querySelector(sel);
      const api = (window.CTCT_REVIEW && CTCT_REVIEW.bindControls)
        ? CTCT_REVIEW.bindControls()
        : { apply: ()=>{} };

      $('#printBtn')?.addEventListener('click', ()=>window.print());

      function countNow(){
        const items = Array.from(document.querySelectorAll('.qa, .qitem'));
        const total = items.length;
        const ok    = items.filter(el => el.classList.contains('ok') || el.dataset.ok==='1').length;
        const bad   = items.filter(el => el.classList.contains('bad')|| el.classList.contains('ng') || el.dataset.ok==='0').length;
        const skip  = items.filter(el => el.classList.contains('skip') || /kh√¥ng tr·∫£ l·ªùi/i.test(el.textContent)).length;
        const visible = items.filter(el => !(el.hidden || el.style.display==='none')).length;

        $('#statTotal').textContent   = total;
        $('#statOk').textContent      = ok;
        $('#statBad').textContent     = bad;
        $('#statSkip').textContent    = skip;
        $('#statVisible').textContent = visible;
      }

      // G·ªçi ƒë·∫øm ngay sau khi core apply
      const origApply = api.apply || function(){};
      api.apply = function(){ origApply(); countNow(); };

      // L·∫ßn ƒë·∫ßu:
      window.addEventListener('load', ()=>{ origApply(); countNow(); });

      // Ph√≤ng tr∆∞·ªùng h·ª£p ng∆∞·ªùi d√πng g√µ search ‚Äì c·ª© ·∫©n/hi·ªán l√† c·∫≠p nh·∫≠t l·∫°i
      $('#onlyWrong')?.addEventListener('change', countNow);
      $('#searchBox')?.addEventListener('input', debounce(countNow,200));

      function debounce(fn,ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn.apply(null,a),ms); }; }
    })();
  </script>
</body>
</html>
