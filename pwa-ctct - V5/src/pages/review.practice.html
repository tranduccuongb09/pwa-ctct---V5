<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Xem l·∫°i &amp; Gi·∫£i th√≠ch ‚Äî √în tr·∫Øc nghi·ªám</title>

  <link rel="manifest" href="../../public/manifest.webmanifest">
  <link rel="stylesheet" href="../css/review-polish.css">

  <style>
    .topbar{background:#A41919;color:#fff;padding:12px 16px;position:sticky;top:0;z-index:20;box-shadow:0 1px 0 rgba(0,0,0,.06)}
    .topbar a{color:#fff;text-decoration:none;font-weight:700}
    .topbar a:hover{text-decoration:underline}
    .wrap{max-width:1100px;margin:16px auto;padding:0 12px}
    .pillbar{display:flex;flex-wrap:wrap;gap:.6rem;margin:12px 0}
    .pill{display:inline-flex;align-items:center;gap:.5rem;padding:.38rem .7rem;border-radius:999px;background:#f3f4f6;font-weight:700}
  </style>
  <link rel="icon" href="data:,">

</head>
<body>
  <div class="topbar">
    <a href="index.html">‚Üê Trang ch·ªß</a>
    <strong style="margin-left:10px">XEM L·∫†I &amp; GI·∫¢I TH√çCH ‚Äî √îN TR·∫ÆC NGHI·ªÜM</strong>
  </div>

  <main class="wrap">
    <div class="toolbar sticky">
      <label class="chk"><input id="onlyWrong" type="checkbox"> Ch·ªâ hi·ªán c√¢u sai</label>

      <div class="field">üîé <input id="searchBox" type="search" placeholder="Nh·∫≠p t·ª´ kh√≥a‚Ä¶"></div>

      <div class="field">
        <select id="expMode">
          <option value="auto">Gi·∫£i th√≠ch ‚Äî T·ª± ƒë·ªông</option>
          <option value="show">Lu√¥n hi·ªán</option>
          <option value="hide">·∫®n</option>
        </select>
      </div>

      <button id="printBtn" class="btn">üñ®Ô∏è In/PDF</button>
    </div>

    <div class="panel">
      <div class="pillbar" id="metaPills"></div>
    </div>

    <div class="panel">
      <div id="reviewList"></div>
      <div class="footer">
        <a class="btn" href="practice.html">‚Üª Quay l·∫°i √în tr·∫Øc nghi·ªám</a>
        <a class="btn" href="leaderboard.html">üìä B·∫£ng x·∫øp h·∫°ng</a>
        <a class="btn primary" href="materials.html">üìö V·ªÅ t√†i li·ªáu h·ªçc t·∫≠p</a>
      </div>
    </div>
  </main>

  <script>
  (function(){
    const LS_KEY='ctct_try_last_result'; // gi·ªØ nguy√™n nh∆∞ b·∫£n anh g·ª≠i
    const pack=safeParse(localStorage.getItem(LS_KEY));
    const pills=document.getElementById('metaPills');
    const list=document.getElementById('reviewList');

    if(!pack || !Array.isArray(pack.details)){
      list.innerHTML='<div style="padding:16px">Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xem l·∫°i. H√£y ho√†n th√†nh m·ªôt l∆∞·ª£t √¥n tr·∫Øc nghi·ªám.</div>';
      return;
    }

    const items=[
      pack.name?`üë§ ${pack.name}`:'',
      pack.unit?`üè¢ ${pack.unit}`:'',
      pack.position?`üéñ ${pack.position}`:'',
      `üìà T·ªïng c√¢u: ${Number(pack.total||pack.details.length||0)}`
    ].filter(Boolean);
    pills.innerHTML=items.map(t=>`<span class="pill">${escapeHtml(t)}</span>`).join('');

    list.innerHTML=(pack.details||[]).map((d,i)=>{
      const chosen=(d.chosen||'').trim(), correct=(d.correct||'').trim();
      const answered=!!chosen, ok=answered && chosen===correct;
      const status=!answered
        ? `‚Äî <b>Kh√¥ng tr·∫£ l·ªùi</b> ‚Ä¢ ƒê√∫ng: <b>${escapeHtml(correct||'-')}</b>`
        : ok
          ? `‚úî ƒê√∫ng ‚Äî B·∫°n ch·ªçn: <b>${escapeHtml(chosen)}</b> ‚Ä¢ ƒê√∫ng: <b>${escapeHtml(correct)}</b>`
          : `‚úò Sai ‚Äî B·∫°n ch·ªçn: <b>${escapeHtml(chosen||'‚Äî')}</b> ‚Ä¢ ƒê√∫ng: <b>${escapeHtml(correct)}</b>`;
      const exp=(d.explanation||'').trim();
      const idx = Number(d.index || i+1);
      return `
        <div class="qa ${ok?'ok':answered?'ng':'skip'}" data-qindex="${idx}" data-ok="${ok?'1':'0'}" data-answered="${answered?'1':'0'}">
          <div class="qhead"><span class="qindex">C√¢u ${idx}.</span></div>
          <p class="qtext">${escapeHtml(d.question||'')}</p>
          <p class="result ${ok?'ok':'ng'}">${status}</p>
          ${exp?`<div class="exp"><b>Gi·∫£i th√≠ch:</b> ${escapeHtml(exp)}</div>`:''}
        </div>`;
    }).join('');

    wireUx(list);

    function wireUx(list){
      document.getElementById('printBtn')?.addEventListener('click',()=>window.print());
      const sb=document.getElementById('searchBox'), onlyWrong=document.getElementById('onlyWrong'), expSel=document.getElementById('expMode');

      function applyFilters(){
        const term=(sb?.value||'').trim().toLowerCase();
        const showWrongOnly=!!(onlyWrong && onlyWrong.checked);

        list.querySelectorAll('mark.hl').forEach(m=>{ const t=document.createTextNode(m.textContent); m.replaceWith(t); });
        const rx=term?new RegExp(term.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'),'gi'):null;

        list.querySelectorAll('.qa').forEach(q=>{
          const ok=q.dataset.ok==='1';
          const text=(q.querySelector('.qtext')?.textContent||'').toLowerCase();
          let hit=true;
          if(term) hit=text.includes(term);
          if(showWrongOnly && ok) hit=false;
          q.style.display=hit?'':'none';
          if(hit && rx){
            const p=q.querySelector('.qtext');
            p.innerHTML=p.textContent.replace(rx,m=>`<mark class="hl">${m}</mark>`);
          }
        });

        applyExpMode();
      }

      function applyExpMode(){
        const mode = expSel ? expSel.value : 'auto';
        list.querySelectorAll('.qa').forEach(q=>{
          const exp = q.querySelector('.exp'); if(!exp) return;
          if (mode==='show') exp.hidden=false;
          else if (mode==='hide') exp.hidden=true;
          else exp.hidden = (q.dataset.ok==='1');
        });
      }

      sb && sb.addEventListener('input', debounce(applyFilters,220));
      onlyWrong && onlyWrong.addEventListener('change', applyFilters);
      expSel && expSel.addEventListener('change', applyExpMode);

      const ji=document.getElementById('jumpInput'), jb=document.getElementById('jumpBtn');
      function jump(){
        const n=parseInt(ji.value||'0',10); if(!n) return;
        const el=list.querySelector(`[data-qindex="${n}"]`);
        if(el){ el.scrollIntoView({behavior:'smooth',block:'start'}); el.classList.add('pulse'); setTimeout(()=>el.classList.remove('pulse'),700); }
      }
      jb && jb.addEventListener('click', jump);
      ji && ji.addEventListener('keydown', e=>{ if(e.key==='Enter') jump(); });

      applyFilters();
    }

    function debounce(fn,ms){ let t; return function(){ clearTimeout(t); t=setTimeout(()=>fn.apply(this,arguments),ms); }; }
    function safeParse(s){ try{return JSON.parse(s||'null')}catch(_){return null} }
    function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[m])); }
  })();
  </script>
  <script src="../js/review-normalize.js?v=20251004-fix2"></script>
  <script src="../js/review-core.js?v=20251004-fix3"></script>
  
</body>
</html>
